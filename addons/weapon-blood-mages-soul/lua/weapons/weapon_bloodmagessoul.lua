/*

 ██████╗██████╗ ███████╗ █████╗ ████████╗███████╗██████╗     ██████╗ ██╗   ██╗    ███╗   ███╗ █████╗ ██████╗  █████╗ ███╗   ██╗███████╗ ██████╗ 
██╔════╝██╔══██╗██╔════╝██╔══██╗╚══██╔══╝██╔════╝██╔══██╗    ██╔══██╗╚██╗ ██╔╝    ████╗ ████║██╔══██╗██╔══██╗██╔══██╗████╗  ██║╚══███╔╝██╔═══██╗
██║     ██████╔╝█████╗  ███████║   ██║   █████╗  ██║  ██║    ██████╔╝ ╚████╔╝     ██╔████╔██║███████║██████╔╝███████║██╔██╗ ██║  ███╔╝ ██║   ██║
██║     ██╔══██╗██╔══╝  ██╔══██║   ██║   ██╔══╝  ██║  ██║    ██╔══██╗  ╚██╔╝      ██║╚██╔╝██║██╔══██║██╔══██╗██╔══██║██║╚██╗██║ ███╔╝  ██║   ██║
╚██████╗██║  ██║███████╗██║  ██║   ██║   ███████╗██████╔╝    ██████╔╝   ██║       ██║ ╚═╝ ██║██║  ██║██║  ██║██║  ██║██║ ╚████║███████╗╚██████╔╝
 ╚═════╝╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝   ╚═╝   ╚══════╝╚═════╝     ╚═════╝    ╚═╝       ╚═╝     ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝ ╚═════╝ 

------------------------------------------------------------------------------------------------------------------------------------------------------

██████╗  ██████╗     ███╗   ██╗ ██████╗ ████████╗    ██████╗ ███████╗██╗   ██╗██████╗ ██╗      ██████╗  █████╗ ██████╗                               
██╔══██╗██╔═══██╗    ████╗  ██║██╔═══██╗╚══██╔══╝    ██╔══██╗██╔════╝██║   ██║██╔══██╗██║     ██╔═══██╗██╔══██╗██╔══██╗                              
██║  ██║██║   ██║    ██╔██╗ ██║██║   ██║   ██║       ██████╔╝█████╗  ██║   ██║██████╔╝██║     ██║   ██║███████║██║  ██║                              
██║  ██║██║   ██║    ██║╚██╗██║██║   ██║   ██║       ██╔══██╗██╔══╝  ██║   ██║██╔═══╝ ██║     ██║   ██║██╔══██║██║  ██║                              
██████╔╝╚██████╔╝    ██║ ╚████║╚██████╔╝   ██║       ██║  ██║███████╗╚██████╔╝██║     ███████╗╚██████╔╝██║  ██║██████╔╝                              
╚═════╝  ╚═════╝     ╚═╝  ╚═══╝ ╚═════╝    ╚═╝       ╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═╝     ╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝                               

██╗███╗   ██╗     █████╗ ███╗   ██╗██╗   ██╗    ███████╗██╗  ██╗ █████╗ ██████╗ ███████╗     ██████╗ ██████╗     ███████╗ ██████╗ ██████╗ ███╗   ███╗
██║████╗  ██║    ██╔══██╗████╗  ██║╚██╗ ██╔╝    ██╔════╝██║  ██║██╔══██╗██╔══██╗██╔════╝    ██╔═══██╗██╔══██╗    ██╔════╝██╔═══██╗██╔══██╗████╗ ████║
██║██╔██╗ ██║    ███████║██╔██╗ ██║ ╚████╔╝     ███████╗███████║███████║██████╔╝█████╗      ██║   ██║██████╔╝    █████╗  ██║   ██║██████╔╝██╔████╔██║
██║██║╚██╗██║    ██╔══██║██║╚██╗██║  ╚██╔╝      ╚════██║██╔══██║██╔══██║██╔═══╝ ██╔══╝      ██║   ██║██╔══██╗    ██╔══╝  ██║   ██║██╔══██╗██║╚██╔╝██║
██║██║ ╚████║    ██║  ██║██║ ╚████║   ██║       ███████║██║  ██║██║  ██║██║     ███████╗    ╚██████╔╝██║  ██║    ██║     ╚██████╔╝██║  ██║██║ ╚═╝ ██║
╚═╝╚═╝  ╚═══╝    ╚═╝  ╚═╝╚═╝  ╚═══╝   ╚═╝       ╚══════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝     ╚══════╝     ╚═════╝ ╚═╝  ╚═╝    ╚═╝      ╚═════╝ ╚═╝  ╚═╝╚═╝     ╚═╝

-------------------------------------------------------- DO NOT REUPLOAD IN ANY SHAPE OR FORM -------------------------------------------------------- 
-------------------------------------------------------- DO NOT REUPLOAD IN ANY SHAPE OR FORM -------------------------------------------------------- 
-------------------------------------------------- IF YOU EDIT ANYTHING YOU ARE VOID OF MY SUPPORT --------------------------------------------------- 
-------------------------------------------------- IF YOU EDIT ANYTHING YOU ARE VOID OF MY SUPPORT --------------------------------------------------- 

*/
AddCSLuaFile()
AddCSLuaFile( "autorun/cl_mas_bloodmagessoul_options.lua" )
AddCSLuaFile( "autorun/sh_mas_bloodmagessoul_fonts.lua" )
include( "autorun/cl_mas_bloodmagessoul_options.lua" )
include( "autorun/sh_mas_bloodmagessoul_fonts.lua" )

if (CLIENT) then

	SWEP.PrintName			= "MAS: Blood Mage's Soul"
	SWEP.Author				= "Maranzo"
	SWEP.Category 			= "1. Maranzo's Ability SWEPs"
	SWEP.Instructions		= [[
	LMB: Attack
	RMB: Ability 1
	"F" Key: Ability 2
	"C" Key: Ability 3
	"T" Key: Ultimate Ability
	Mouse3: Ability Selection
	
	]]
	
end // end If Client

SWEP.ViewModel			=	Model( "models/weapons/c_arms.mdl" )
SWEP.UseHands			=	true
SWEP.WorldModel			=	""
SWEP.HoldType			=	"fist"
SWEP.ViewModelFOV 		= 	54
SWEP.Spawnable 			= 	GetConVar( "sk_mas_bloodmagessoul_enabled" ):GetBool()
SWEP.AdminOnly 			= 	GetConVar( "sk_mas_bloodmagessoul_adminonly" ):GetBool()

SWEP.Weight				= 	5
SWEP.AutoSwitchTo		= 	true
SWEP.AutoSwitchFrom		= 	false
SWEP.ShouldDropOnDie	=	false

SWEP.Slot				= 	1 -- Secondary weapon
SWEP.SlotPos			= 	0 -- Takes up the beginning slot
SWEP.DrawAmmo			= 	false -- Do not show ammo on HUD
SWEP.DrawCrosshair		= 	true

SWEP.Primary.ClipSize		= 	-1 -- Infinite Ammo
SWEP.Primary.DefaultClip	= 	-1 -- Starts Infinite
SWEP.Primary.Automatic		= 	true -- is automatic
SWEP.Primary.Ammo			= 	"none" -- "none" bc no ammo needed
SWEP.Primary.MaxDistance	= 	6000 -- "none" bc no ammo needed
SWEP.Primary.Spread			= 	0 -- "none" bc no ammo needed
SWEP.Primary.Damage			= 	25
SWEP.Primary.DamageUppercut	= 	40

SWEP.Secondary.ClipSize		= 	-1 -- Infinite again
SWEP.Secondary.DefaultClip	= 	-1
SWEP.Secondary.Automatic	= 	false -- is not automatic
SWEP.Secondary.Ammo			= 	"none" -- No ammo needed

SWEP.SwingDelay1			=	1
SWEP.SwingDelay2			=	0.5
SWEP.ModDelay				=	1
SWEP.ModDmg					=	1
SWEP.Hit					= 	false
SWEP.HitTime				= 	CurTime()
SWEP.HitDistance		 	= 	1000

// Abilities

ASWEP_Ability_AutoAttack		= 1
ASWEP_Ability_LightningBolt		= 2
ASWEP_Ability_MagicBlast		= 3
ASWEP_Ability_BloodCurse		= 4
ASWEP_Ability_Calamity			= 5
ASWEP_Ability_Select			= 6
ASWEP_Ability_Holster			= 7

SWEP.AbilityTable = {
	["Equipped"] = {
		[ASWEP_Ability_AutoAttack]		= {
			["Category"] = "AutoAttack",
			["Name"] = "Magic Bolt",
			["Description"] = "Fire a bolt of magic energy at your target or Cast a selected ability." },
		[ASWEP_Ability_LightningBolt]		= { ["Category"] = "Ability 1", ["Name"] = "Lightning Bolt", ["Description"] = "Strike your target with a bolt of lightning that deals 50 damage." },
		[ASWEP_Ability_MagicBlast]	= { ["Category"] = "Ability 2", ["Name"] = "Magic Blast", ["Description"] = "Land an attack to concentrate magic energy around your target and blast them with it!" },
		[ASWEP_Ability_BloodCurse]	= {	["Category"] = "Ability 3", ["Name"] = "Blood Curse", ["Description"] = "Land an attack to curse your target! While active, drain health and slow your target each hit." },
		[ASWEP_Ability_Calamity]		= {	["Category"] = "Ultimate", ["Name"] = "Calamity", ["Description"] = "Your thirst for blood manifests itself as everything around you is drained of its life." },
	},
}

-------------------------------------------------------------------

local ability_icons = {
	[ASWEP_Ability_AutoAttack] 		= { def = Material( 'hud/maranzo_abilityswep/icon_aa_magicbolt.png' ), 	cast = Material( 'hud/maranzo_abilityswep/icon_aa_magicbolt.png' ) },
	[ASWEP_Ability_LightningBolt] 	= { def = Material( 'hud/maranzo_abilityswep/icon_lightningbolt.png' ), 		cast = Material( 'hud/maranzo_abilityswep/icon_lightningbolt_cast.png' ) },
	[ASWEP_Ability_MagicBlast] 		= { def = Material( 'hud/maranzo_abilityswep/icon_magicblast.png' ), 		cast = Material( 'hud/maranzo_abilityswep/icon_magicblast_cast.png' ) },
	[ASWEP_Ability_BloodCurse]		= { def = Material( 'hud/maranzo_abilityswep/icon_bloodcurse.png' ), 	cast = Material( 'hud/maranzo_abilityswep/icon_bloodcurse_cast.png' ) },
	[ASWEP_Ability_Calamity] 		= { def = Material( 'hud/maranzo_abilityswep/icon_calamity.png' ), 		cast = Material( 'hud/maranzo_abilityswep/icon_calamity_cast.png' ) },
}

local function DrawCenteredRect( x, y, w, h )
	surface.DrawTexturedRect( x - w / 2, y - h / 2, w, h )
end

	
if (CLIENT) then
	killicon.Add( "weapon_bloodmagessoul", "icons/weapon_bloodmagessoul_killicon", color_white )
	local WepSelectIcon = Material( "icons/weapon_bloodmagessoul_select.png" )
	local Size = 128
	
	function SWEP:DrawWeaponSelection( x, y, w, h, a )
		surface.SetDrawColor( 255, 255, 255, a )
		surface.SetMaterial( WepSelectIcon )
	
		surface.DrawTexturedRect( x + ( ( w - Size ) / 2 ), y + 2, Size, Size )
	
		-- Draw weapon info box
		self:PrintWeaponInfo( x + w + 20, y + h * 0.95, a )
	end
end

-------------------------------------------------------------------
-- Precache Misc Sounds

local SwingSound = Sound( "WeaponFrag.Throw" )
local MagicSendSound = Sound( "npc/manhack/mh_blade_snick1.wav" )
local HitSound = Sound( "physics/wood/wood_deepimpact2.wav" )

--------------------------------------------------------------------
-- Define Local Functions

// Keys down for SinglePlayer
local keysDown = {}

// Effect F'n for think
local function playEffect( origin, entity, flags, effectstr, iterations, scale, magnitude, r1, r2, rz )
	
	if !iterations then iterations = 1 end
	if !scale then scale = 1 end
	if !magnitude then magnitude = 1 end
	if !r1 then r1 = 0 r2 = 0 end
	if !r2 then r2 = r1 end
		local TF_ed = EffectData()
		TF_ed:SetOrigin( origin )
		TF_ed:SetEntity( entity )
		TF_ed:SetFlags( flags )
		TF_ed:SetScale( scale )
		TF_ed:SetMagnitude( magnitude )
	for i=1, iterations do
		local randVec = !rz and Vector( math.random( -r1, r2 ), math.random( -r1, r2 ), 0 ) or Vector( math.random( -r1, r2 ), math.random( -r1, r2 ), math.random( -r1, r2 ) )
		TF_ed:SetOrigin( origin + randVec )
		util.Effect( effectstr, TF_ed, true, true )
	end
	
end

--------------------------------------------------------------------
-- Define SWEP Functions

local MAS = {}
function SWEP:Initialize()
	self.Spawnable			= 	GetConVar( "sk_mas_bloodmagessoul_enabled" ):GetBool()
	self.AdminOnly			= 	GetConVar( "sk_mas_bloodmagessoul_adminonly" ):GetBool()
	
	if Maranzos_AbilitySWEPs then 
		Maranzos_AbilitySWEPs.BMS_InfUlt= tobool( GetConVarNumber( "sk_mas_bloodmagessoul_infinitecharge" ) )
		Maranzos_AbilitySWEPs.BMS_NoCD	= tobool( GetConVarNumber( "sk_mas_bloodmagessoul_nocooldown" ) )
		
		table.Merge( MAS, Maranzos_AbilitySWEPs ) -- Merge that shit rather than reference it
	end
	
	MAS.IsCasting					=	false
	MAS.Ability 					=	{}
	MAS.Ability.AA 					= 	{}	-- Auto Attack
	MAS.Ability.LightBt 			= 	{}	-- Lightning Bolt
	MAS.Ability.MagicBl 			= 	{}	-- Magic Blast
	MAS.Ability.BloodCr 			= 	{}	-- Blood Curse
	MAS.Ability.Calamity 			= 	{}	-- Ultimate: Calamity
	
	-- Ultimate: Calamity
	MAS.Ability.Calamity.Damage			=	7	-- per 0.1s
	MAS.Ability.Calamity.Heal			=	7	-- per 0.1s
	MAS.Ability.Calamity.Duration		=	3	-- in seconds
	MAS.Ability.Calamity.MaxCharge		=	100
	MAS.Ability.Calamity.SoundCast		= 	Sound( "npc/vort/vort_dispell.wav" )
	MAS.Ability.Calamity.SoundLoop		= 	Sound( "doors/drawbridge_move1.wav" ) -- Loops on targets
	MAS.Ability.Calamity.SoundLoop2		= 	Sound( "hl1/ambience/alien_powernode.wav" ) -- Loops from player
	MAS.Ability.Calamity.SoundLoop3		= 	Sound( "hl1/ambience/alien_blipper.wav" ) -- Loops on player
	MAS.Ability.Calamity.SoundHit		= 	Sound( "physics/flesh/flesh_squishy_impact_hard2.wav" )
	MAS.Ability.Calamity.SoundEnd		= 	Sound( "physics/debris/gravel_dirt/debris_gravel_dirt_07.wav" )
	
	-- Lightning Bolt
	MAS.Ability.LightBt.Cooldown		=	10	-- seconds
	MAS.Ability.LightBt.Damage			=	50
	MAS.Ability.LightBt.SoundCast		=	Sound( "npc/vort/vort_attack_shoot1.wav" )	-- seconds
	MAS.Ability.LightBt.SoundHit		=	Sound( "npc/antlion_guard/antlion_guard_shellcrack2.wav" )	-- seconds
	MAS.Ability.LightBt.SoundMiss		=	Sound( "phx/hmetal1.wav" )	-- seconds
	
	-- Magic Blast
	MAS.Ability.MagicBl.Cooldown		=	18	-- seconds
	MAS.Ability.MagicBl.CooldownMiss	=	10	-- seconds
	MAS.Ability.MagicBl.Damage			=	50
	MAS.Ability.MagicBl.Duration		=	1	-- seconds
	MAS.Ability.MagicBl.ForceMul		=	850
	MAS.Ability.MagicBl.SoundCast		= 	Sound( "physics/concrete/boulder_impact_hard3.wav" )
	MAS.Ability.MagicBl.SoundCharge		= 	Sound( "npc/strider/charging.wav" )
	MAS.Ability.MagicBl.SoundHit		= 	Sound( "physics/flesh/flesh_squishy_impact_hard3.wav" )
	MAS.Ability.MagicBl.SoundMiss		=	Sound( "phx/hmetal1.wav" )
	
	-- Blood Curse
	MAS.Ability.BloodCr.Cooldown		=	14	-- seconds
	MAS.Ability.BloodCr.CooldownMiss	=	6	-- seconds
	MAS.Ability.BloodCr.Duration		=	4
	MAS.Ability.BloodCr.LSMul			=	0.3	-- HP LS
	MAS.Ability.BloodCr.ForceMul		=	0.85 -- Target's Momentum * this
	MAS.Ability.BloodCr.SoundCast		=	Sound( "npc/combine_gunship/ping_search.wav" ) -- Activate Sound
	MAS.Ability.BloodCr.SoundHit		=	Sound( "npc/strider/strider_step5.wav" ) -- Currently not in use
	MAS.Ability.BloodCr.SoundMiss		=	Sound( "phx/hmetal1.wav" ) -- Currently not in use
	
	if Maranzos_AbilitySWEPs.BMS_NoCD then
		self.SwingDelay1					=	0.3
		self.SwingDelay2					=	0.3
		MAS.Ability.Calamity.Cooldown		=	1
		MAS.Ability.LightBt.Cooldown		=	1
		MAS.Ability.MagicBl.Cooldown		=	1
		MAS.Ability.BloodCr.Cooldown		=	1
		MAS.Ability.MagicBl.CooldownMiss	=	1
		MAS.Ability.BloodCr.CooldownMiss	=	1
	end
	
	
	local ply = self.Owner
	
	if (CLIENT) then
		self.DrawCrosshair		= 	GetConVar( "cl_mas_crosshairon" ):GetBool()
		self.KB = Maranzos_AbilitySWEPs.keyconfigs
		
		// Define a table of instructions
		self.Instr = {}
		self.Instr["H1"] = self.KB[ 1 ] .. " : "
		self.Instr["H2"] = self.KB[ 2 ] .. " : "
		self.Instr["H3"] = self.KB[ 3 ] .. " : "
		self.Instr["H4"] = self.KB[ 4 ] .. " : "
		self.Instr["H5"] = self.KB[ 5 ] .. " : "
		self.Instr["H6"] = self.KB[ 6 ] .. " : "
		self.Instr["1"] = "Attack / Cast Ability"
		self.Instr["2"] = "Lightning Bolt"
		self.Instr["3"] = "Magic Blast"
		self.Instr["4"] = "Blood Curse"
		self.Instr["5"] = "Ultimate: Calamity"
		self.Instr["6"] = "Ability Selection"
		self.Instr["7"] = "\n".. "Check the Options menu to Rebind Abilities and Enable Menu & Flashlight use."
	
		// Run when key pressed
		if !game.SinglePlayer() then
			hook.Add( "PlayerButtonDown", "MAS.Keybind.BloodMagesSoul" .. ply:EntIndex(), function( ply, btn )
				local Wep = ply:GetActiveWeapon()
				
				if ( ply:IsValid() and ply:Alive() and Wep:IsValid() and Wep:GetClass() == "weapon_bloodmagessoul" ) then
					
					if self.KB and self.KB["Btn"][btn] and IsFirstTimePredicted() then 
						-- AutoAttack & Ability #1:Lightning Bolt are bound to +attack & +attack2 by default & won't trigger anything here.
						if !vgui.CursorVisible() then
							
							if self.KB["Btn"][btn] == ASWEP_Ability_MagicBlast then 
							// Abil 2: Magic Blast
								local CD = MAS.Ability.MagicBl.Cooldown
								if ( !( self:GetA2_Active() or self:GetA2_CD() == CD + 2 ) and ( self:GetIsCasting() or self:GetA2_CD() != 0 ) ) then 
									return 
								end
								local ability = ASWEP_Ability_MagicBlast
								self:SetIsCasting( true )
								
								net.Start( "Maranzo_AbilitySWEP_BloodMagesSoul_Cast" )
								net.WriteInt( ability, 4 )
								net.SendToServer()
								
							elseif self.KB["Btn"][btn] == ASWEP_Ability_BloodCurse then 
							// Abil 3: Blood Curse
								local CD = MAS.Ability.BloodCr.Cooldown
								if ( !( self:GetA3_Active() or self:GetA3_CD() == CD + 2 ) and ( self:GetIsCasting() or self:GetA3_CD() != 0 ) ) then 
									return 
								end
								local ability = ASWEP_Ability_BloodCurse
								self:SetIsCasting( true )
								
								net.Start( "Maranzo_AbilitySWEP_BloodMagesSoul_Cast" )
								net.WriteInt( ability, 4 )
								net.SendToServer()
								
							elseif self.KB["Btn"][btn] == ASWEP_Ability_Calamity then 
							// Ultimate: Calamity
								if ( self:GetIsCasting() or self:GetAU_Active() ) then 
									return -- do nothing
								end
								
								self:SetIsCasting( true )
								local ability = ASWEP_Ability_Calamity
								
								net.Start( "Maranzo_AbilitySWEP_BloodMagesSoul_Cast" )
								net.WriteInt( ability, 4 )
								net.SendToServer()
								
							end // end Key Check
						end // end if cursor visible
						
						if self.KB["Btn"][btn] == ASWEP_Ability_Select then
						// Ability Selection
							self:DrawAbilitySelection()
							
						end // end Key check, cursor visible OK
						
					end // end Btn Pushed Check
				end // end if ply & alive & weapon
			end) // end Hook
		else // if game is SinglePlayer
			-- do nothing
		end // end if SinglePlayer
	
		// Run when key pressed
		hook.Add( "PlayerBindPress", "MAS.Keybind.BloodMagesSoul" .. ply:EntIndex(), function( ply, bind, down )
			local Wep = ply:GetActiveWeapon()
			if ( ply and ply:IsValid() and ply:Alive() and MASconvar_preventbinds:GetBool() and Wep:IsValid() and ply:GetActiveWeapon():GetClass() == "weapon_bloodmagessoul" ) then
				if ( string.find( bind, "impulse 100" ) or string.find( bind, "+menu" ) or string.find( bind, "+menu_context" ) ) then 
					return true
				end // end string find 
			end // end if Valid
		end) // end Hook
		
	end // end If Client
	
	self:SetHoldType( "fist" )
	if (SERVER) then
		self:SetCharge( 0 )
	end

end

function SWEP:DrawAbilitySelection()
	
	if ( MAS.Editor != nil ) then
		MAS.Editor:Remove()
		MAS.Editor = nil
	elseif !vgui.CursorVisible() then
		local x = ScrW()
		local y = ScrH()
		local BGColor = Color( 0, 130, 200, 200 )
		local FGColor = Color(50, 50, 50, 150)
		local BorderColor = Color( 0, 100, 165, 255 )
		local TColor1 = Color(255, 255, 255, 255)
		local TColor2 = Color(255, 180, 20, 255)
		local TColor3 = Color(255, 240, 220, 255)
		local TColorBG = Color(60, 60, 60, 255)
		local OvlColor = Color(255, 255, 0, 100)
		MAS.Editor = vgui.Create( "DFrame" ) //Create a Frame to contain everything.
		MAS.Editor:SetTitle( "" )
		MAS.Editor:SetSize( x, y )
		MAS.Editor:Center()
		MAS.Editor:SetVisible( true )
		MAS.Editor:ShowCloseButton( false )
		function MAS.Editor:Paint()
			surface.SetDrawColor( BGColor )
			surface.DrawRect( 0, 0, x, y )
			surface.SetDrawColor( BorderColor )
			for i=1, 6 do
				surface.DrawOutlinedRect( 0+i, 0+i, x - i*2, y - i*2 )
			end
			local Tx = x/2
			local Ty = y/20
			draw.SimpleText("Ability Selection", "MaranzoAbil_UltimateFont", Tx + 2, Ty + 2, TColorBG, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
			draw.SimpleText("Ability Selection", "MaranzoAbil_UltimateFont", Tx, Ty, TColor1, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
		end
			
		local DButton = vgui.Create( "DButton", MAS.Editor )
		local size = 64
		local border = 12
		DButton:SetSize( size, size )
		DButton:SetPos( x - size - border, y - size - border )
		DButton:SetText( "Close" )
		DButton:SetTextColor( TColor1 )
		DButton:SetFontInternal( "MaranzoAbil_DefaultFont" )
		DButton:SetExpensiveShadow( 1, TColorBG )
		DButton.DoClick = function()
			MAS.Editor:Remove()
			MAS.Editor = nil
		end
		local Dw, Dh
		function DButton:Paint( w, h)
			Dw = w
			Dh = h
			draw.RoundedBox( 8, 0, 0, Dw, Dh, BorderColor )
			draw.RoundedBox( 8, 0, 0, Dw - 4, Dh - 4, FGColor )
		end
		
		
		MAS.Editor.Scroll = vgui.Create( "DScrollPanel", MAS.Editor ) //Create the Scroll panel
		MAS.Editor.Scroll:SetSize( x - 24, y - y/5 )
		MAS.Editor.Scroll:SetPos( 12, y/20 )
		
		MAS.Editor.List = vgui.Create( "DIconLayout", MAS.Editor.Scroll )
		MAS.Editor.List:SetSize( x - 30, y - y/5 )
		MAS.Editor.List:SetPos( 0, 0 )
		MAS.Editor.List:SetSpaceX( 5 )
		MAS.Editor.List:SetSpaceY( 10 )
		
		// Create list
		for k, v in ipairs( self.AbilityTable["Equipped"] ) do -- ipairs is a temp fix until I add additional abilities
			local ListItem = MAS.Editor.List:Add( "DPanel" ) //Add DPanel to the DIconLayout
			ListItem:SetSize( MAS.Editor.List:GetWide(), y/7 ) //Set the size of it
			function ListItem:Paint( w, h )
				local drawColor = Color( 255, 255, 255, 255 )
				local ability = k
				local material = ability_icons[ ability ] and ability_icons[ ability ].def or ability_icons[ ASWEP_Ability_AutoAttack ].def
				local size = 64
				local Tx = w/50
				local Ty = 2
				surface.SetMaterial( material )
				surface.SetDrawColor( drawColor )
				DrawCenteredRect( size/2 + Tx, h/2, size, size )
				draw.SimpleText( v["Category"], "MaranzoAbil_DefaultFont", Tx +2, 2 +2, TColorBG, TEXT_ALIGN_LEFT, TEXT_ALIGN_LEFT )
				draw.SimpleText( v["Category"], "MaranzoAbil_DefaultFont", Tx, 2, TColor2, TEXT_ALIGN_LEFT, TEXT_ALIGN_LEFT )
				draw.SimpleText( v["Name"], "MaranzoAbil_DefaultFont", Tx +2, h - 28 +2, TColorBG, TEXT_ALIGN_LEFT, TEXT_ALIGN_LEFT )
				draw.SimpleText( v["Name"], "MaranzoAbil_DefaultFont", Tx, h - 28, TColor1, TEXT_ALIGN_LEFT, TEXT_ALIGN_LEFT )
			end // end ListItem Paint
			
			local DLabel = vgui.Create( "DLabel", ListItem )
			local w = ListItem:GetWide()
			local h = ListItem:GetTall()
			local Tx, Sx
			if x > 1200 then
				if x > 1350 then Tx = w/7 Sx = w - Tx * 2.5
				else Tx = w/6 Sx = w - Tx * 2 end
			else Tx = w/4 Sx = w - Tx end
			
			local Ty = 12
			DLabel:SetSize( Sx, h - 14 )
			DLabel:SetPos( Tx, Ty )
			DLabel:SetText( v["Description"] )
			DLabel:SetContentAlignment( 4 )
			DLabel:SetTextColor( TColor3 )
			DLabel:SetTextInset( 0, 0 )
			DLabel:SetFontInternal( "MaranzoAbil_DefaultFont" )
			DLabel:SetWrap( true )
			DLabel:SetExpensiveShadow( 1, TColorBG )
			
		end // end For Loop List Creation
		
	end
	
end

function SWEP:DrawHUD()
	
	// Setup Var's used across the board
	local Charge = self:GetCharge()
	local ability
	local ACTIVE
	local CD
	
	if !MASconvar_drawhud:GetBool() then return end
	// Ability Icon Draw
	local drawColor = ( prohibited ) and Color( 100, 100, 100, 255 ) or Color( 255, 255, 255, 255 ) -- shortened If statement	
	local size = ( menushown && ability == menu_ability ) and 128 or 64 // 128 | 64
	local ultsize = ( menushown && ability == menu_ability ) and 128 or 128 // 128 | 64
	
	-- positioning
	local x = ScrW()/2 -- Ult (Center)
	local y = ScrH() - 70
	local dif = 110
	local x0 = x - dif * 1.7 -- AA
	local x1 = x - dif
	local x2 = x + dif
	local x3 = x + dif * 1.7
	local TxtY = y + size * 0.65
	local Txt2Y = y + size * 0.65 + 2
	local TColor = Color(255, 255, 255, 255)
	local T2Color = Color(20, 20, 20, 255)
	
	// Auto-Attack
	ability = ASWEP_Ability_AutoAttack
	ACTIVE = self:GetAA_Active()
	CD = self:GetAA_CD()
	drawColor = ( CD > 0 ) and Color( 100, 100, 100, 255 ) or Color( 255, 255, 255, 255 ) -- shortened If statement
	surface.SetMaterial( ability_icons[ ability ].def )
	surface.SetDrawColor( drawColor )
	DrawCenteredRect( x0, y, size, size )
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x0 + 1, Txt2Y, T2Color, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x0, TxtY, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	
	// Ability 1
	ability = ASWEP_Ability_LightningBolt
	ACTIVE = self:GetA1_Active()
	CD = self:GetA1_CD()
	if !ACTIVE then // Not Active
		surface.SetMaterial( ability_icons[ ability ].def )
		
		if CD > 0 then
			drawColor = Color( 100, 100, 100, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x1, y, size, size )
			draw.SimpleText( CD, "MaranzoAbil_DefaultFont", x1, y, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
		else
			drawColor = Color( 255, 255, 255, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x1, y, size, size )
		end
		
	else // Active
		drawColor = Color( 255, 255, 255, 255 ) -- shortened If statement
		surface.SetMaterial( ability_icons[ ability ].cast )
		surface.SetDrawColor( drawColor )
		DrawCenteredRect( x1, y, size, size )
	end // end if Active
	
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x1 + 1, Txt2Y, T2Color, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x1, TxtY, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	
	
	// Ability 2
	ability = ASWEP_Ability_MagicBlast
	ACTIVE = self:GetA2_Active()
	CD = self:GetA2_CD()
	if !ACTIVE then // Not Active
		surface.SetMaterial( ability_icons[ ability ].def )
		
		if CD > 0 then
			drawColor = Color( 100, 100, 100, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x2, y, size, size )
			draw.SimpleText( CD, "MaranzoAbil_DefaultFont", x2, y, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
		else
			drawColor = Color( 255, 255, 255, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x2, y, size, size )
		end
		
	else // Active
		drawColor = Color( 255, 255, 255, 255 )
		surface.SetMaterial( ability_icons[ ability ].cast )
		surface.SetDrawColor( drawColor )
		DrawCenteredRect( x2, y, size, size )
	end // end if Active
	
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x2 + 1, Txt2Y, T2Color, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x2, TxtY, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	
	
	// Ability 3
	ability = ASWEP_Ability_BloodCurse
	ACTIVE = self:GetA3_Active()
	CD = self:GetA3_CD()
	if !ACTIVE then // Not Active
		surface.SetMaterial( ability_icons[ ability ].def )
		
		if CD > 0 then
			drawColor = Color( 100, 100, 100, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x3, y, size, size )
			draw.SimpleText( CD, "MaranzoAbil_DefaultFont", x3, y, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
		else
			drawColor = Color( 255, 255, 255, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x3, y, size, size )
		end
		
	else // Active
		drawColor = Color( 255, 255, 255, 255 )
		surface.SetMaterial( ability_icons[ ability ].cast )
		surface.SetDrawColor( drawColor )
		DrawCenteredRect( x3, y, size, size )
	end // end if Active
	
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x3 + 1, Txt2Y, T2Color, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x3, TxtY, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	
	// Ultimate
	ability = ASWEP_Ability_Calamity
	ACTIVE = self:GetAU_Active()
	if !ACTIVE then // Not Active
		surface.SetMaterial( ability_icons[ ability ].def )
		
		if Charge < 100 then
			drawColor = Color( 100, 100, 100, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x, y - 32, size * 1.7, size * 1.7 )
		else
			drawColor = Color( 255, 255, 255, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x, y - 32, ultsize, ultsize )
		end
		
	else // Active
		drawColor = Color( 255, 255, 255, 255 )
		surface.SetMaterial( ability_icons[ ability ].cast )
		surface.SetDrawColor( drawColor )
		DrawCenteredRect( x, y - 32, ultsize, ultsize )
	end // end if Active
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x + 1, Txt2Y, T2Color, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x, TxtY, drawColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	
	
----------------------------
	// Variables
	-- local ChargeColor = Color(40,200,255,180) - Nice Blue
	local ChargeColor = Color(255,255,255,255)
	local FullChargeColor = Color(255,200,40,180)
	local x = ScrW() * 0.5
	local y = ScrH() - 120
	
	// Charge HUD Draw
	if Charge >= MAS.Ability.Calamity.MaxCharge then
		-- do nothing
	elseif !ACTIVE then // not max charge & not active
		-- Draw Charge %
		local ChargeText = Charge.."%"
		draw.SimpleText(ChargeText, "MaranzoAbil_UltimateFont", x + 12, ScrH() - 98, Color( 20, 20, 20, 255 ), TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
		draw.SimpleText(ChargeText, "MaranzoAbil_UltimateFont" , x + 10, ScrH() - 100, ChargeColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	end
	
	return true
  end

// Specifically draw crosshair
function SWEP:DoDrawCrosshair( x, y )	
	-- little box
    surface.SetDrawColor(0, 0, 0, 125)
    surface.DrawRect(x - 3, y - 3, 6, 6)
    
    surface.SetDrawColor(255, 255, 255, 150)
    surface.DrawRect( x - 2, y - 2, 4, 4)
	return true
end

function SWEP:SetupDataTables()

	self:NetworkVar( "Float", 0, "NextMeleeAttack" )
	self:NetworkVar( "Float", 1, "NextIdle" )
	self:NetworkVar( "Float", 2, "AA_CD" )
	self:NetworkVar( "Float", 3, "A1_CD" )
	self:NetworkVar( "Float", 4, "A2_CD" )
	self:NetworkVar( "Float", 5, "A3_CD" )
	
	self:NetworkVar( "Int", 0, "Charge" )
	
	self:NetworkVar( "String", 0, "Ability" )
	
	self:NetworkVar( "Bool", 0, "AA_Active" )
	self:NetworkVar( "Bool", 1, "A1_Active" )
	self:NetworkVar( "Bool", 2, "A2_Active" )
	self:NetworkVar( "Bool", 3, "A3_Active" )
	self:NetworkVar( "Bool", 4, "AU_Active" )
	self:NetworkVar( "Bool", 5, "IsCasting" )
	self:NetworkVar( "Bool", 6, "CastOnLand" )

end

function SWEP:UpdateNextIdle( ply )
	
	local ply = ply or self.Owner
	local vm = ply:GetViewModel()
	self:SetNextIdle( CurTime() + vm:SequenceDuration() / vm:GetPlaybackRate() )

end

local reloadToggle = false
local reloadTime = CurTime()
function SWEP:Reload()
	
	local curtime = CurTime()
	if curtime < reloadTime then return end
	reloadTime = curtime + 0.5
	if self:GetAU_Active() then return end
	
	-- Visual FX
	local anim					=	reloadToggle and "fists_draw" or "fists_holster"
	local vm 					= 	self.Owner:GetViewModel()
	local speed 				= 	GetConVarNumber( "sv_defaultdeployspeed" ) or 1
	local Duration				= 	vm:SequenceDuration() / speed
	local CD					=	reloadToggle and Duration or 1000000000
	local HoldType				=	reloadToggle and "fist" or "normal"
	vm:SendViewModelMatchingSequence( vm:LookupSequence( anim ) )
	self:SetHoldType( HoldType )
	self:SetNextPrimaryFire( curtime + CD )
	self:SetNextSecondaryFire( curtime + CD )
	self:SetNextIdle( curtime + CD )
	if self:GetA2_Active() and self:GetA2_CD() > MAS.Ability.MagicBl.Cooldown then
		self:SetA2_Active( false )
		self:SetA2_CD( 0 )
	end
	if self:GetA3_Active() and self:GetA3_CD() > MAS.Ability.BloodCr.Cooldown then
		self:SetA3_Active( false )
		self:SetA3_CD( 0 )
	end
	
	reloadToggle = !reloadToggle
	self:SetIsCasting( reloadToggle )
	
	return false
end

-- The shoot effect: Thank you Garry & robotboy655
function SWEP:DoShootEffect( hitpos, hitnormal, entity, physbone, bFirstTimePredicted )
	
	if ( !bFirstTimePredicted ) then return end

	local effectdata = EffectData()
	effectdata:SetOrigin( hitpos )
	effectdata:SetNormal( hitnormal )
	effectdata:SetEntity( entity )
	effectdata:SetAttachment( physbone )
	util.Effect( "selection_indicator", effectdata )

	local effectdata = EffectData()
	effectdata:SetOrigin( hitpos )
	effectdata:SetStart( self.Owner:GetShootPos() - Vector( 0, 0, 10 ) )
	effectdata:SetAttachment( 1 )
	effectdata:SetEntity( self )
	util.Effect( "ToolTracer", effectdata )

end

--
-- Called when the left mouse button is pressed
--
function SWEP:PrimaryAttack( right )
	
	local ply = self.Owner
	local vm = self.Owner:GetViewModel()
	
	self:SetAA_Active( true )
	self.Owner:SetAnimation( PLAYER_ATTACK1 )
	self:SetNextMeleeAttack( CurTime() + 0.2 * self.ModDelay )
	
	local anim = "fists_left"
	if ( right ) then 	// Ability 1: Lightning Bolt
		anim = "fists_right"
		CD = self.SwingDelay2 * self.ModDelay
		self:SetAA_CD( CD )
		timer.Simple( CD, function()
			if self:IsValid() and !self:GetAA_Active() then self:SetAA_CD( 0 ) end
		end)
		self:SetNextPrimaryFire( CurTime() + CD )
		self:SetNextSecondaryFire( CurTime() + self:GetA1_CD() )
		
	else // Not A1, is AA
		local rand = math.Round(CurTime()) / 2
		if ( math.Round(rand) == rand ) then anim = "fists_left" else anim = "fists_right" end
		if self:GetA2_CD() == MAS.Ability.MagicBl.Cooldown + 2 then anim = "fists_uppercut" end
		CD = self.SwingDelay1 * self.ModDelay
		self:SetAA_CD( CD )
		timer.Simple( CD, function()
			if self:IsValid() and !self:GetAA_Active() then self:SetAA_CD( 0 ) end
		end)
		self:SetNextPrimaryFire( CurTime() + CD )
		self:SetNextSecondaryFire( CurTime() + self.SwingDelay2 * self.ModDelay )
	end // end if AA
	
	vm:SendViewModelMatchingSequence( vm:LookupSequence( anim ) )
	self:EmitSound( SwingSound )

	if ( SERVER ) then
		
	
		local randPitch = math.random( 70, 40 )
		self.Owner:EmitSound( MagicSendSound, 75, randPitch )
		
	end // end If Server
	
	self:UpdateNextIdle()

end

function SWEP:SecondaryAttack()
	
	if !IsFirstTimePredicted() then return end
	local A1_CD = self:GetA1_CD()
	local AA_CD = self:GetAA_CD()
	
	if ( A1_CD != 0 ) then return end
	
	local CD = MAS.Ability.LightBt.Cooldown
	self:SetA1_Active( true )
	self:SetA1_CD( CD )
	self:PrimaryAttack( true )
	
end

function SWEP:GetTracerOrigin()
	local origin = self.Owner:GetShootPos() - Vector( 0, 0, 5 )
	return origin
end

function SWEP:DealDamage( ability )

	local anim = self:GetSequenceName(self.Owner:GetViewModel():GetSequence())
	local ply = self.Owner
	
	self.Owner:LagCompensation( true )
	
	local trace = util.TraceHull( {
		start = self.Owner:GetShootPos(),
		endpos = self.Owner:GetShootPos() + self.Owner:GetAimVector() * self.Primary.MaxDistance,
		filter = self.Owner,
		mins = Vector( -10, -10, -8 ),
		maxs = Vector( 10, 10, 8 ),
		mask = MASK_SHOT_HULL
	} )
	
	if ( !trace.Hit ) then 
	
		if ability then
			if ability == ASWEP_Ability_LightningBolt then
				ply:EmitSound( MAS.Ability.LightBt.SoundMiss, 40 )
			elseif ability == ASWEP_Ability_MagicBlast then
				self:MagicBlast( trace )
			elseif ability == ASWEP_Ability_BloodCurse then
				self:BloodCurse( trace )
			end
		end
		
	end // end if !trace hit
	
	if SERVER and IsValid( trace.Entity ) && ( trace.Entity:IsNPC() || trace.Entity:IsPlayer() ) && !trace.Entity:IsLagCompensated() then
		trace.Entity:SetLagCompensated( true )
	end
	
	local BulletCalled = false
	
	local Bullet = {}
		Bullet.Attacker = 	self.Owner
		Bullet.Num		=	1
		Bullet.Src		=	ply:GetShootPos()
		Bullet.Dir		=	ply:GetAimVector()
		Bullet.Distance	=	self.Primary.MaxDistance
		Bullet.HullSize =	10
		Bullet.Spread	=	Vector( self.Primary.Spread, self.Primary.Spread, 0 )
		Bullet.Tracer	=	1 -- Tracer every bullet
		Bullet.TracerName	= ability and "" or "AirboatGunHeavyTracer"
		Bullet.Force	=	1
		Bullet.Damage	=	self.Primary.Damage
		Bullet.AmmoType	=	"" -- No ammo type
		Bullet.Callback = function( attacker, tr, dmginfo )

	self.Hit = false
	dmginfo:SetInflictor( self )
	
	if ability then
		if ability == ASWEP_Ability_LightningBolt then
			self:LightningBolt( tr.Entity )
			dmginfo:SetDamage( MAS.Ability.LightBt.Damage * self.ModDmg )
			self:DoShootEffect( tr.HitPos, tr.HitNormal, tr.Entity, tr.PhysicsBone, IsFirstTimePredicted() )
		elseif ability == ASWEP_Ability_MagicBlast then
			self:MagicBlast( trace )
			-- Nullify bullet damage
			dmginfo:SetDamage( 0 )
			dmginfo:SetDamageType( DMG_FALL )
			dmginfo:SetInflictor( tr.Entity )
			dmginfo:SetAttacker( tr.Entity )
		elseif ability == ASWEP_Ability_BloodCurse then
			self:BloodCurse( trace )
			-- Continue normal bullet path
		end
	end
	
	if ( SERVER && IsValid( tr.Entity ) && ( tr.Entity:IsNPC() || tr.Entity:IsPlayer() || tr.Entity:Health() > 0 ) ) then
		
		local randPitch = math.random( 70, 130 )
		tr.Entity:EmitSound( HitSound, 90, randPitch )
		
		if ( !IsValid( attacker ) ) then attacker = self end
		dmginfo:SetDamageType( DMG_GENERIC )
		

		if ( anim == "fists_left" ) then
			dmginfo:SetDamageForce( self.Owner:GetRight() * 4912 + self.Owner:GetForward() * 9998 ) -- Yes we need those specific numbers
		elseif ( anim == "fists_right" ) then
			dmginfo:SetDamageForce( self.Owner:GetRight() * -4912 + self.Owner:GetForward() * 9989 )
		elseif ( anim == "fists_uppercut" ) then
			dmginfo:SetDamageForce( self.Owner:GetUp() * 5158 + self.Owner:GetForward() * 10012 )
		end
		
		-- Set a static amount of damage
		tr.Entity:TakeDamageInfo( dmginfo )
		
		-- Set Charge & Hit
		self.Hit = true
		local charge = self:GetCharge() + dmginfo:GetDamage()/10 
		self:SetCharge( charge )
		self.HitTime = CurTime()
		
		-- Nullify bullet damage
		dmginfo:SetDamage( 0 )
		dmginfo:SetDamageType( DMG_FALL )
		dmginfo:SetInflictor( tr.Entity )
		dmginfo:SetAttacker( tr.Entity )
		

	end // end if Server & Entity
	
	end // end callback function
	
	self.Owner:FireBullets( Bullet )

	self.Owner:LagCompensation( false )

end // end DealDamage Function

//// Lightning Bolt ////
function SWEP:LightningBolt( target )
	
	local ply	=	self.Owner
	local CD	=	self:GetA1_CD()
	
	if SERVER then
		if ply:IsValid() and ply:Alive() and CD > 0 then
			// Ply Effect
			ply:EmitSound( MAS.Ability.LightBt.SoundCast )
			
			if target:IsValid() and ( target:IsNPC() or target:IsPlayer() ) then
				
				//Effect
				local Origin = target:GetPos() + Vector(0,0,1)
				local Origin2 = target:GetShootPos()
				playEffect( Origin2, target, 1, "Sparks", 1, 1, 3 )
				playEffect( Origin2, target, 3, "ElectricSpark", 1, 1, 10 )
				playEffect( Origin2, target, 3, "TeslaHitboxes", 2, 10, 10 )
				target:EmitSound( MAS.Ability.LightBt.SoundHit )
				target:EmitSound( MAS.Ability.LightBt.SoundCast )
			
			end // end if target
		end // end if ply
	end // end If Server
	
end // end Lightning Bolt Ability

//// Magic Blast ////
function SWEP:MagicBlast( trace )
	
	local ply	=	self.Owner
	local CD	=	self:GetA2_CD()
	local target = 	trace.Entity
	
	if ply:IsValid() and ply:Alive() and CD > 0 then
		
		if self:IsValid() then
			
			-- If Missed Attack
			if !target:IsValid() or ( !target:IsNPC() and !target:IsPlayer() ) then
				self:SetA2_Active( false )
				self:SetIsCasting( false )
				
				if SERVER then ply:EmitSound( MAS.Ability.MagicBl.SoundMiss, 40 ) end
				
				-- Countdown CD
				CD = MAS.Ability.MagicBl.CooldownMiss
				self:SetA2_CD( CD )
				local itCD = CD
				timer.Create( "MAS.Ability.MagicBlast.CD" .. ply:EntIndex() , 1, itCD, function()
					if self:IsValid() then
						CD = CD - 1
						self:SetA2_CD( CD )
					else
						timer.Remove( "MAS.Ability.MagicBlast.CD" .. ply:EntIndex() )
					end
				end)
				
				return
			end
			
			-- Do Magic Blast
			local it = 0.1
			local Dur = MAS.Ability.MagicBl.Duration * 10
			if SERVER then -- Initial FX
				// Ply Effect
				ply:EmitSound( MAS.Ability.MagicBl.SoundCast )
				target:EmitSound( MAS.Ability.MagicBl.SoundCharge, 85 )
			end
			timer.Create( "Mas.Ability.MagicBlast.Cast" .. ply:EntIndex() , 0.1, Dur, function() 
				
				Dur = Dur - 1
				--Check if ply & self & target
				if ply:IsValid() and ply:Alive() and ply:GetActiveWeapon():GetClass() == "weapon_bloodmagessoul" and target:IsValid() and ( target:IsNPC() or target:IsPlayer() ) then
					
					if SERVER then
					
						if Dur == 0 then
							
						-- Blast the target & dmg nearby enemies
							local origin = target:GetPos()
							local insphere = ents.FindInSphere( origin, 100 )
							local targets = {}
							
							local dmginfo = DamageInfo()
							local attacker = self.Owner
							if ( !IsValid( attacker ) ) then attacker = self end
							
							dmginfo:SetAttacker( attacker )
							dmginfo:SetInflictor( self )
							dmginfo:SetDamage( MAS.Ability.MagicBl.Damage * self.ModDmg )
							
							for k, v in ipairs(insphere) do
								if (!v:Health() or v:Health() == 0 or v == ply) and v:GetClass() != "prop_physics" then continue end
								
								-- Damage!
								local entpos	=	v:GetPos()
								local dist 		=	math.Clamp((math.Distance(origin.x, origin.y, entpos.x, entpos.y) / 100), 1, 100)
								local force		= 	MAS.Ability.MagicBl.ForceMul
								force 			= 	(-(origin - entpos):GetNormalized() * force + Vector(0,0,300) ) / dist
								if (v:GetClass()=="prop_physics" and v:GetPhysicsObject():IsValid()) then 
									v:GetPhysicsObject():SetVelocity( force / 5 )
								else 
									dmginfo:SetDamageForce( force )
									v:TakeDamageInfo( dmginfo )
									if v:GetClass() == "npc_strider" then force = Vector( 0, 0, 0 ) end -- prevent striders fly glitch
									v:SetVelocity( force ) 
									table.insert(targets,v)
								end
							end // end for loop
							
							//Effect
							local Origin = target:GetPos() + Vector(0,0,1)
							local Origin2 = target:GetShootPos()
							playEffect( Origin2, target, 0, "Explosion", 1, 1, 1 )
							playEffect( Origin2, target, 1, "bloodspray", 1, 8, 1 )
							target:EmitSound( MAS.Ability.MagicBl.SoundHit, 100 )
							
							//Reward
							self:SetCharge( self:GetCharge() + math.Round( 4 * #targets ) )
							
							-- Set Inactive
							self:SetA2_Active( false )
							self:SetIsCasting( false )
							
						else // if Dur != 0
							//Effect
							local Origin = target:GetPos() + Vector(0,0,10)
							local Origin2 = target:GetShootPos()
							playEffect( Origin, target, 3, "WheelDust", 1, math.Clamp( 10/Dur,1,3 ), 100 )
							
							// Ability
							local Vel = target:GetVelocity()
							target:SetVelocity( -Vel * 0.5 )
						end // end if Dur != 0
						
					end // end If Server
					
				else // else if !Ply Valid or !Self Valid remove timer
					timer.Remove( "Mas.Ability.MagicBlast.Cast" .. ply:EntIndex() )
				end
				
			end) // End Cast Timer
			
			-- Countdown CD
			CD = MAS.Ability.MagicBl.Cooldown
			self:SetA2_CD( CD )
			local itCD = CD
			timer.Create( "MAS.Ability.MagicBlast.CD" .. ply:EntIndex() , 1, itCD, function()
				if self:IsValid() then
					CD = CD - 1
					self:SetA2_CD( CD )
				else
					timer.Remove( "MAS.Ability.MagicBlast.CD" .. ply:EntIndex() )
				end
			end)
		end // if self is Valid
	end // end if ply
	
end // end Lightning Bolt Ability

//// Blood Curse Debuff ////
function SWEP:BloodCurse( trace )
	-- Heal self & gain extra damage
	local ply	=	self.Owner
	local CD	=	self:GetA3_CD()
	local target = trace.Entity
	
	if SERVER then
		if ply:IsValid() and ply:Alive() and CD > 0 then
			
			if self:IsValid() then
			
				-- If Missed Attack
				if !target:IsValid() or ( !target:IsNPC() and !target:IsPlayer() ) then
					self:SetA3_Active( false )
					self:SetIsCasting( false )
					
					ply:EmitSound( MAS.Ability.BloodCr.SoundMiss, 40 )
					
					-- Countdown CD
					CD = MAS.Ability.BloodCr.CooldownMiss
					self:SetA3_CD( CD )
					local itCD = CD
					timer.Create( "MAS.Ability.BloodCr.CD" .. ply:EntIndex() , 1, itCD, function()
						if self:IsValid() then
							CD = CD - 1
							self:SetA3_CD( CD )
						else
							timer.Remove( "MAS.Ability.BloodCr.CD" .. ply:EntIndex() )
						end
					end)
					
					return
				end
			
				// Deactivate ability
				self:SetIsCasting( false )
				local dur = MAS.Ability.BloodCr.Duration
				timer.Simple( dur, function() 
					if self:IsValid() then 
						self:SetA3_Active( false )
					end
				end )
				
				// Countdown CD on server
				local CD = MAS.Ability.BloodCr.Cooldown
				self:SetA3_CD( CD )
				local itCD = CD
				timer.Create( "MAS.Ability.BloodCurse.CD" .. ply:EntIndex() , 1, itCD, function()
					if self:IsValid() then
						CD = CD - 1
						self:SetA3_CD( CD )
					else
						timer.Remove( "MAS.Ability.BloodCurse.CD" .. ply:EntIndex() )
					end
				end)
				
				// Initial FX
				local Origin = target:GetPos() + Vector( 0, 0, 10 )
				ply:EmitSound( MAS.Ability.BloodCr.SoundCast, 90 )
				target:EmitSound( MAS.Ability.BloodCr.SoundHit, 95 )
				playEffect( Origin, target, 1, "bloodspray", 1, 10, 1 )
				playEffect( Origin, target, 3, "WheelDust", 2, 2, 3 )
				
				// Set future variables
				local forcemul	=	MAS.Ability.BloodCr.ForceMul	-- damage mul
				local ls 		= 	MAS.Ability.BloodCr.LSMul 	-- hp LS
				
				// Debuff: Take health & slow momentum
				hook.Add( "EntityTakeDamage", "MAS.Ability.BloodCurse.Debuff"..ply:EntIndex(), function( ent, dmginfo )
					if ent == target and dmginfo:GetAttacker() == ply and dmginfo:GetInflictor() == self then
						
						// Slow Momentum
						if ent:IsValid() and ent:Health() > 0 then
							local vel		=	ent:GetVelocity()
							local Origin 	= 	target:GetPos() + Vector( 0, 0, 10 )
							if ent:IsPlayer() then ent:SetVelocity( -vel * forcemul ) 	-- if Player
							else ent:SetVelocity( vel + ( -vel * forcemul )  ) end 		-- if NPC 
							playEffect( Origin, ent, 3, "bloodspray", 1, 8, 1 )
							playEffect( Origin, ent, 3, "WheelDust", 1, 1, 3 )
						end // end Ent Valid & Alive
						
						// Heal on Hit
						if ply:IsValid() and ply:Alive() then
							local dmg 		= 	dmginfo:GetDamage()
							local health 	= 	ply:Health() + dmg * ls
							
							if (ply:GetMaxHealth() < health) then -- if HP full, do nothing
								health = ply:GetMaxHealth()
								if (ply:Health() > health) then health = ply:Health() end -- if HP overcharged, do not lower it
							end
							ply:SetHealth(health)
						end // end Ply Valid & Alive
					end
				end) // end Hook
				
				// Debuff: Remove
				timer.Create( "MAS.Ability.BloodCurse.Debuff" .. ply:EntIndex(), dur, 1, function()
					hook.Remove( "EntityTakeDamage", "MAS.Ability.BloodCurse.Debuff"..ply:EntIndex() )
				end) // end timer
			end // end if Self Valid
		end // end Checks
	end // end If Server
	
end // end ScornMark Ability


///// ULTIMATE ABILITY /////
function SWEP:Calamity( ply )
	
	local ply = ply or self.Owner
	
	local Charge = self:GetCharge()
	
	if Charge >= 100 then -- ULTIMATE Ability
		if !self:GetIsCasting() and ply:IsValid() and ply:Alive() then
			// Prevent other abilities
			self:SetAU_Active( true )
			self:SetIsCasting( true )
			
			// Define variables
			local timeset	 			= 	0
			local vel 					= 	ply:GetVelocity()
			local vm 					= 	ply:GetViewModel()
			local anim					=	"fists_holster"
			local speed 				= 	GetConVarNumber( "sv_defaultdeployspeed" ) or 1
			local WEP					=	ply:GetActiveWeapon()
			
			// ViewModel + Prevent Attacks
			vm:SendViewModelMatchingSequence( vm:LookupSequence( anim ) )
			local dur = MAS.Ability.Calamity.Duration
			WEP:SetNextPrimaryFire( CurTime() + dur )
			WEP:SetNextSecondaryFire( CurTime() + dur )
			self:SetNextIdle( CurTime() + dur + 1 )
			
			// Initial FX
			local Origin = ply:GetPos() + Vector( 0, 0, 1 )
			local Origin2 = ply:GetShootPos()
			self:SetCharge( 0 )
			ply:EmitSound( MAS.Ability.Calamity.SoundCast )
			
			// Ability Loop for Duration
			local Dur = MAS.Ability.Calamity.Duration * 10
			local itDur = Dur
			timer.Create( "MAS.Ability.Calamity.Cast"..ply:EntIndex() , 0.1, Dur, function()
				itDur = itDur - 1
				local WEP = ply:GetActiveWeapon()
				if ( ply:IsValid() && ply:Alive() && WEP:GetClass() == "weapon_bloodmagessoul" ) then
					if	(SERVER) then
						// Looped FX
						local origin = ply:GetPos()
						playEffect( origin, ply, 1, "ThumperDust", 1, 300, 1 )
			
						// Health Drain & Damage
						local insphere = ents.FindInSphere( origin, 200 )
						local targets = {}
						
						local dmginfo = DamageInfo()
						local dmg = MAS.Ability.Calamity.Damage
						local attacker = ply
						if ( !IsValid( attacker ) ) then attacker = WEP end
						
						dmginfo:SetAttacker( attacker )
						dmginfo:SetInflictor( WEP )
						dmginfo:SetDamage( dmg * self.ModDmg )
						dmginfo:SetDamageType( DMG_GENERIC )
						
						for k, v in ipairs(insphere) do
							if ( !v:Health() or v:Health() < 1 or v == ply ) then continue end
							-- Damage!
							local entpos	=	v:GetPos()
							local dist 		=	math.Clamp((math.Distance(origin.x, origin.y, entpos.x, entpos.y) / 100), 1, 100)
							local force		= 	5000
							force 			= 	(-(origin - entpos):GetNormalized() * force + Vector(0,0,300) ) / dist
							local rand		=	math.random( 1, 20 )
							if rand == 2 then playEffect( entpos, v, 1, "bloodspray", 1, 8, 1 ) end
							dmginfo:SetDamageForce( force )
							v:TakeDamageInfo( dmginfo )
							
							-- Slow Momentum!
							local vel = v:GetVelocity()
							if v:IsPlayer() then v:SetVelocity( -vel * 0.8 ) else v:SetVelocity( vel + (-vel * 0.8) ) end
							table.insert(targets,v)
						end // end for loop
						local health = ply:Health()
						if health < ply:GetMaxHealth() then	-- Don't lower overhealed HP
							health = health + ( MAS.Ability.Calamity.Heal * #targets )
							if health > ply:GetMaxHealth() then health = ply:GetMaxHealth() end -- Don't Overheal
						end
						ply:SetHealth( health )
						self:SetCharge( self:GetCharge() + #targets * 1 ) -- 1 Charge per Target each 0.1s, AKA 30 max per target if they have ~210 hp
						
					end // end if Server
					
					// End the Ability
					if itDur == 0 then
						timer.Simple( 0.1, function()
							if ply:IsValid() and ply:Alive() then
							
								if WEP:IsValid() and WEP:GetClass() == "weapon_bloodmagessoul" then
									// ViewModel & Can Attack again
									anim = "fists_draw"
									-- anim = "draw"
									vm:SendViewModelMatchingSequence( vm:LookupSequence( anim ) )
									self:UpdateNextIdle( ply )
									local dur = vm:SequenceDuration() / speed
									WEP:SetNextPrimaryFire( CurTime() + dur )
									WEP:SetNextSecondaryFire( CurTime() + dur )
									self:SetAU_Active( false )
									self:SetIsCasting( false )
								end
								// Finishing FX
								ply:EmitSound( MAS.Ability.Calamity.SoundEnd )
								
							end // end ply valid & alive
						end) // end timer
					end // end if Dur == 0
					
				else // end if Ply valid or !WEP
					timer.Remove( "MAS.Ability.Calamity.Cast"..ply:EntIndex() )
				end
			end)
		end // end if Is Casting
	else // end if charge 100%
		if Maranzos_AbilitySWEPs.BMS_InfUlt then
			self:SetCharge( 100 )
		end
	end
	return true
end

// Dropped Weapon
function SWEP:OnDrop()

	self:Remove() -- You can't drop a soul

end

// Holster
function SWEP:Holster()
	-- Prevent abilities from working if weapon switched to prevent abuse
	if SERVER and ( self:GetA2_Active() or self:GetA3_Active() or self:GetAU_Active() ) then
		self.Owner:ChatPrint( "[MAS] Blood Mage's Soul: Ability Canceled - Weapon Switched")
	end
	reloadToggle = false
	self:SetCastOnLand( false )
	self:SetA2_Active( false )
	if self:GetA2_CD() > MAS.Ability.LightBt.Cooldown then self:SetA2_CD( 0 ) end
	self:SetA3_Active( false )
	if self:GetA3_CD() > MAS.Ability.BloodCr.Cooldown then self:SetA3_CD( 0 ) end
	self:SetAU_Active( false )
	self:SetIsCasting( false )
	return true
	
end

// Weapon Info
function SWEP:PrintWeaponInfo(x, y, alpha)

	if (self.DrawWeaponInfoBox == false) then return end

	if (self.InfoMarkup == nil) then
		local str
		local title_color = "<color = 255, 200, 0, 255>"
		local hl_color = "<color = 247, 168, 32, 200>"
		local text_color = "<color = 255, 255, 255, 200>"
		
		str = "<font=DermaDefaultBold>"
		if (self.Author != "") then str = str .. title_color .. "Author:</color>\t" .. text_color .. self.Author .. "</color>\n" end
		if (self.Contact != "") then str = str .. title_color .. "Contact:</color>\t" .. text_color .. self.Contact .. "</color>\n\n" end
		if (self.Purpose != "") then str = str .. title_color .. "Purpose:</color>\n" .. text_color .. self.Purpose .. "</color>\n\n" end

		-- Set the instructions
		if (self.Instructions != "") then str = str .. title_color .. "Instructions:</color>\n"
			local myInstr = self.Instr
			for i = 1, table.Count(myInstr) do
				local HL = myInstr["H"..i]
				local TL = myInstr[""..i]
				if ( HL != nil ) then
					str = str .. hl_color .. HL .. text_color .. TL .. "\n"
					table.remove( myInstr, i )
					table.remove( myInstr, tostring(i) )
				elseif TL != nil then -- If No Headline, then Check Text Line
					str = str .. text_color .. TL .. "\n"
				end
			end
		end // end of Instructions
		str = str .. "</font>"
		
		self.InfoMarkup = markup.Parse(str, 250)
	end
	
	local outerColor 	= 	Color( 0, 100, 165, 255 )
	local innerColor 	= 	Color( 0, 130, 200, 255 )
	
	surface.SetDrawColor(outerColor)
	surface.SetTexture(self.SpeechBubbleLid)
	surface.DrawTexturedRect(x, y - 69.5, 128, 64) 
	draw.RoundedBox(8, x - 5, y - 6, 260, self.InfoMarkup:GetHeight() + 18, outerColor)
	draw.RoundedBox(8, x - 2, y - 3, 254, self.InfoMarkup:GetHeight() + 12, innerColor)
	
	self.InfoMarkup:Draw(x + 5, y + 5, nil, nil, alpha)
end

// Deployed Weapon
function SWEP:Deploy()
	
	local speed = GetConVarNumber( "sv_defaultdeployspeed" ) or 1
	local vm = self.Owner:GetViewModel()
	vm:SetPlaybackRate( speed )
	vm:SendViewModelMatchingSequence( vm:LookupSequence( "fists_draw" ) )
	local dur = vm:SequenceDuration() / speed
	self:SetNextPrimaryFire( CurTime() + dur )
	self:SetNextSecondaryFire( CurTime() + dur )
	self:UpdateNextIdle()

	if ( SERVER ) then
		-- do nothing
	else // Client
		self.DrawCrosshair		= 	GetConVar( "cl_mas_crosshairon" ):GetBool()
	end
	
	return true

end // end Fn Deploy

// Weapons Think Too
function SWEP:Think()
	
	local ply = self.Owner
	local vm = self.Owner:GetViewModel()
	local curtime = CurTime()
	local idletime = self:GetNextIdle()
	
	// Singleplayer Button Check
	if CLIENT and game.SinglePlayer() then
		
		if !vgui.CursorVisible() and !vgui.GetKeyboardFocus() and self.KB then
		
			local Wep = ply:GetActiveWeapon()
			if !( ply:IsValid() and ply:Alive() and Wep:IsValid() and Wep:GetClass() == "weapon_bloodmagessoul" ) then return end
			
			for btn, ability in pairs( self.KB["Btn"] ) do
				if ability != 1 and ability != 2 then
					if ( input.IsButtonDown( btn ) ) and !table.HasValue( keysDown, btn ) then
						table.insert( keysDown, btn )
						
						if ( ply:IsValid() and ply:Alive() and Wep:IsValid() and Wep:GetClass() == "weapon_bloodmagessoul" ) then
							-- AutoAttack & Ability #1:Lightning Bolt are bound to +attack & +attack2 by default & won't trigger anything here.
							
							if ability == ASWEP_Ability_MagicBlast then 
							// Abil 2: Magic Blast
								local CD = MAS.Ability.MagicBl.Cooldown
								if ( !( self:GetA2_Active() or self:GetA2_CD() == CD + 2 ) and ( self:GetIsCasting() or self:GetA2_CD() != 0 ) ) then 
									return 
								end
								self:SetIsCasting( true )
								
								net.Start( "Maranzo_AbilitySWEP_BloodMagesSoul_Cast" )
								net.WriteInt( ability, 4 )
								net.SendToServer()
								
							elseif ability == ASWEP_Ability_BloodCurse then 
							// Abil 3: Blood Curse
								local CD = MAS.Ability.BloodCr.Cooldown
								if ( !( self:GetA3_Active() or self:GetA3_CD() == CD + 2 ) and ( self:GetIsCasting() or self:GetA3_CD() != 0 ) ) then 
									return 
								end
								self:SetIsCasting( true )
								
								net.Start( "Maranzo_AbilitySWEP_BloodMagesSoul_Cast" )
								net.WriteInt( ability, 4 )
								net.SendToServer()
								
							elseif ability == ASWEP_Ability_Calamity then 
							// Ultimate: Calamity
								if ( self:GetIsCasting() or self:GetAU_Active() ) then 
									return -- do nothing
								end
								
								self:SetIsCasting( true )
								
								net.Start( "Maranzo_AbilitySWEP_BloodMagesSoul_Cast" )
								net.WriteInt( ability, 4 )
								net.SendToServer()
								
							end // end Key Check
							
							if ability == ASWEP_Ability_Select then
							// Ability Selection
								self:DrawAbilitySelection()
								
							end // end Key check, cursor visible OK <-- Not set currently for SP
							
						end // end if ply & alive & weapon
						
					elseif !( input.IsButtonDown( btn ) ) and table.HasValue( keysDown, btn ) then
						table.RemoveByValue( keysDown, btn )
					end // end Btn Release
				end // end Exclude AA & A1
			end // end For Btn check
		end // end  if !Mouse Visible
	end // end SinglePlayer
	
	if ( idletime > 0 && curtime > idletime ) then
		
		vm:SendViewModelMatchingSequence( vm:LookupSequence( "fists_idle_0" .. math.random( 1, 2 ) ) )
		self:UpdateNextIdle()
	
	end

	local meleetime = self:GetNextMeleeAttack()
	if ( meleetime > 0 && curtime > meleetime ) then

		self:SetNextMeleeAttack( 0 )
		self:SetAA_Active( false )
		
		-- If Ability 1: Lightning Bolt
		if ( self:GetA1_Active() ) then 
			
			-- Do Lightning Bolt
			self:DealDamage( ASWEP_Ability_LightningBolt )
			self:SetA1_Active( false )
			local CD = self:GetA1_CD()
			local itCD = CD
			timer.Create( "MAS.Ability.LightningBolt.CD" .. ply:EntIndex(), 1, itCD, function()
				if self:IsValid() then
					CD = CD - 1
					self:SetA1_CD( CD )
				else
					timer.Remove( "MAS.Ability.LightningBolt.CD" .. ply:EntIndex() )
				end
			end)
		
		-- If Ability 2: Magic Blast
		elseif ( self:GetA2_Active() and self:GetA2_CD() == MAS.Ability.MagicBl.Cooldown + 2 ) then
			
			-- Do Magic Blast
			self:DealDamage( ASWEP_Ability_MagicBlast )
		
		-- If Ability 3: Blood Curse
		elseif ( self:GetA3_Active() and self:GetA3_CD() == MAS.Ability.BloodCr.Cooldown + 2 ) then
		
			-- Do Magic Blast
			self:DealDamage( ASWEP_Ability_BloodCurse )
			
		else // end if an ability
			self:DealDamage()
		end // end regular attack

	end // end Melee Time
	
end // end SWEP think


----------------------------------------------------------------------
---- Net Usage

if (SERVER) then
	
	util.AddNetworkString( "Maranzo_AbilitySWEP_BloodMagesSoul_Cast" )
	util.AddNetworkString( "Maranzo_AbilitySWEP_BloodMagesSoul_CastCancel" )

	// Run the real ability server-side
	net.Receive( "Maranzo_AbilitySWEP_BloodMagesSoul_Cast", function( len, ply )
		
		if ( IsValid( ply ) and ply:Alive() and ply:GetActiveWeapon():GetClass() == "weapon_bloodmagessoul" ) then
			local ability = net.ReadInt( 4 )
			local Wep = ply:GetActiveWeapon()
			local SWEP = Wep:GetTable()
				
			if ability == ASWEP_Ability_MagicBlast then 
				local CD = MAS.Ability.MagicBl.Cooldown
				if ( !SWEP:GetA2_Active() ) then 
					if ( !SWEP:GetIsCasting() and SWEP:GetA2_CD() == 0 ) then 
						-- Prevent more abilities
						SWEP:SetA2_Active( true )
						SWEP:SetIsCasting( true )
						
						-- Cooldown Active
						SWEP:SetA2_CD( CD + 2 ) -- + 2 so we know it can be canceled still
						// Do not Timer Cooldown until it has been cast with Left Click
						
					end // end if is Casting
				elseif SWEP:GetA2_CD() == CD + 2 then // if it IS active & CD + 2
					SWEP:SetA2_Active( false )
					SWEP:SetIsCasting( false )
					SWEP:SetA2_CD( 0 )
				end // end Magic Blast
				
			elseif ability == ASWEP_Ability_BloodCurse then 
				local CD = MAS.Ability.BloodCr.Cooldown
				if ( !SWEP:GetA3_Active() ) then
					if ( !SWEP:GetIsCasting() and SWEP:GetA3_CD() == 0 ) then
						-- Prevent more Abilities
						SWEP:SetA3_Active( true )
						SWEP:SetIsCasting( true )
						
						-- Cooldown Active
						SWEP:SetA3_CD( CD + 2 )
						// Do not Timer Cooldown until it has been cast with Left Click
						
					end // end if !Casting and CD == 0
					
				elseif SWEP:GetA3_CD() == CD + 2 then // if it IS active & CD + 2
					SWEP:SetA3_Active( false )
					SWEP:SetIsCasting( false )
					SWEP:SetA3_CD( 0 )
				end // end Blood Curse
				
			elseif ability == ASWEP_Ability_Calamity then 
				
				if ( !SWEP:GetAU_Active() and !SWEP:GetIsCasting() ) then
					SWEP:Calamity( ply )
				end
				
			end
			
		end // end If Ply & Weapon
		
	end ) // end Net Receive
	
end

if (CLIENT) then

	net.Receive( "Maranzo_AbilitySWEP_BloodMagesSoul_Cast", function( len, ply )
		
		local ply = LocalPlayer()
		local Wep = ply:GetActiveWeapon()
		local SWEP = Wep:GetTable()
		
		if ( IsValid( ply ) and ply:Alive() and ply:GetActiveWeapon():GetClass() == "weapon_bloodmagessoul" ) then
			local ability = net.ReadInt( 4 )
			
			if ability == ASWEP_Ability_MagicBlast then 
				-- Do nothing right now
				
			elseif ability == ASWEP_Ability_BloodCurse then 
				-- Do nothing right now
				
			elseif ability == ASWEP_Ability_Calamity then 
				
			end
			
		end // end If Ply & Weapon
		
	end ) // end Net Receive
	
	
	
end